# Сервис генерации числового мультипликатора

HTTP-сервис для генерации случайных мультипликаторов с настраиваемым RTP (Return to Player).

## Описание

Сервис генерирует случайные числовые мультипликаторы в диапазоне [1.0, 10000.0] таким образом, чтобы при обработке последовательности чисел клиентом достигался заданный RTP независимо от распределения значений в последовательности.

## Запуск

```bash
go run . -rtp=0.8
```

Параметры:
- `-rtp` - значение RTP в диапазоне (0, 1.0] (по умолчанию: 1.0)

## API

### GET /get

Возвращает сгенерированный мультипликатор в формате JSON.

**Запрос:**
```
GET http://localhost:64333/get
```

**Ответ:**
```json
{
  "result": 2.5
}
```

## Алгоритм работы

### 1. Принцип работы

Сервис использует вероятностный алгоритм для достижения целевого RTP:

- **С вероятностью (1-RTP)**: генерирует мультипликатор = 1.0 (проигрышный)
- **С вероятностью RTP**: генерирует мультипликатор ≥ 1.0 из unbounded Pareto распределения с capping (выигрышный)

Это обеспечивает P(multiplier > x) = RTP / x для x в [1.0, 10000.0].

### 2. Логика клиента

Клиент обрабатывает последовательность чисел по правилам:

```
Если multiplier > x: x остается неизменным
Если multiplier ≤ x: x становится 0
```

### 3. Расчет RTP

```
RTP = sum1 / sum0
```

Где:
- `sum0` - количество элементов в последовательности
- `sum1` - сумма элементов после обработки

## Математическое обоснование

### Цель алгоритма

Достичь соотношения `RTP = sum1/sum0 ≈ заданное_значение_rtp`

### Реализация

1. **Проигрышный путь** (вероятность = 1 - RTP):
   - Возвращает 1.0
   - Для любого x ≥ 1.0: 1.0 ≤ x → x становится 0

2. **Выигрышный путь** (вероятность = RTP):
   - Генерирует unbounded Pareto: v ~ Uniform[0,1], denom = 1 - v, m = 1 / denom
   - Применяет capping: если m > 10000.0, m = 10000.0
   - Обеспечивает P(m > x | выигрыш) = 1 / x точно для x < 10000

### Результат

При большом количестве запросов (>10,000) ожидаемый вклад на элемент стремится к RTP, независимо от x в последовательности.

## Пример работы

### Входные данные:
```
Последовательность: [2.0, 3.0, 100.0, 1.1, 1.1]
RTP = 0.8 (ожидаемый средний вклад ~0.8 на элемент)
```

### Генерация мультипликаторов:
```
2.0 → multiplier = 1.0 → 1.0 ≤ 2.0 → становится 0
3.0 → multiplier = 500 → 500 > 3.0 → остается 3.0
100.0 → multiplier = 1.0 → 1.0 ≤ 100.0 → становится 0
1.1 → multiplier = 2.0 → 2.0 > 1.1 → остается 1.1
1.1 → multiplier = 1.5 → 1.5 > 1.1 → остается 1.1
```

### Результат:
```
Итоговая последовательность: [0, 3.0, 0, 1.1, 1.1]
sum0 = 5 (количество элементов)
sum1 = 0 + 3.0 + 0 + 1.1 + 1.1 = 5.2
RTP = 5.2 / 5 = 1.04 (в маленькой выборке отклонение; при N>10k → 0.8)
```

## Технические детали

- **Порт**: 64333
- **Протокол**: HTTP
- **Формат ответа**: JSON
- **Генератор случайных чисел**: `math/rand` 
- **Потокобезопасность**: Глобальный rand (thread-safe в Go)

## Требования

- Go 1.20+
- Порт 64333 должен быть свободен

## Алгоритм генерации мультипликатора

```go
func generateMultiplier(rtp float64) float64 {
    if rand.Float64() < 1-rtp {
        return 1.0
    }

    // Генерация unbounded Pareto с capping
    v := rand.Float64()
    denom := 1.0 - v
    if denom <= 0 || denom < 1.0/maxMultiplier { // Избежать inf и cap
        return maxMultiplier
    }
    m := 1.0 / denom
    if m > maxMultiplier {
        return maxMultiplier
    }
    return m
}
```

## Объяснение выбора границ

### Граница 1.0 - критическая точка:
- **multiplier = 1.0**: для x ≥ 1.0 → 1.0 ≤ x → x становится 0
- **multiplier > 1.0**: с вероятностью 1/x в выигрыше → multiplier > x → x остается неизменным

### Граница 10000.0 - максимальное покрытие:
- Покрывает все возможные x ∈ [1.0, 10000.0]
- Используется как capping для unbounded Pareto распределения, сохраняя P(m > x) = RTP / x

## Алгоритм Pareto распределения

### Принцип работы

Новый алгоритм использует unbounded Pareto распределение для генерации выигрышных мультипликаторов:

1. **Проигрышный путь** (вероятность = 1-RTP):
   - Возвращает точно `1.0`
   - Гарантирует, что любой `x ≥ 1.0` станет 0

2. **Выигрышный путь** (вероятность = RTP):
   - Генерирует `v ∈ [0, 1)` равномерно
   - Вычисляет `multiplier = 1 / (1 - v)`
   - Применяет capping на `maxMultiplier = 10000.0`

### Преимущества Pareto распределения

- **Более реалистичное распределение**: большинство выигрышей небольшие, редкие - очень большие
- **Лучший игровой опыт**: создает более интересную динамику выигрышей
- **Математическая корректность**: сохраняет точное RTP при любом количестве запросов

## Проверка корректности

При RTP = 0.8 и большом количестве запросов (>10,000):
- Ожидается, что ~80% мультипликаторов будут > 1.0
- Ожидается, что ~20% мультипликаторов будут = 1.0
- Итоговый RTP клиента должен стремиться к 0.8 (проверено симуляцией и тестами на платформе)